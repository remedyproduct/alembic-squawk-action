name: "Alembic Migration Lint with Squawk"
description: "Leverages Squawk to lint Alembic migrations"

inputs:
  migrations_path:
    description: "Path to the folder containing your 'versions' subfolder."
    required: true
  alembic_config:
    description: "Path to alembic.ini."
    required: false
    default: "alembic.ini"

runs:
  using: "composite"
  steps:
    - name: Find changed migrations
      id: modified-migrations
      uses: dorny/paths-filter@v3.0.2
      with:
        list-files: shell
        filters: |
          migrations:
            - '${{ inputs.migrations_path }}/versions/*.py'

    - name: Generate migration SQL
      id: generate-sql
      if: ${{ steps.modified-migrations.outputs.migrations == 'true' }}
      shell: bash
      run: |
        echo "Detected changed migrations: ${{ steps.modified-migrations.outputs.migrations_files }}"
        
        ALEMBIC_RANGE=$(python ${{ github.action_path }}/scripts/range_from_files.py \
          --config "${{ inputs.alembic_config }}" \
          --files "${{ steps.modified-migrations.outputs.migrations_files }}"
        )
        
        echo "Alembic range: $ALEMBIC_RANGE"
        
        # Now call Alembic itself. We assume Alembic is installed in the environment.
        alembic -c "${{ inputs.alembic_config }}" upgrade "$ALEMBIC_RANGE" --sql > migrations.sql
        
        # Set output for changed migrations
        echo "changed=true" >> $GITHUB_OUTPUT

    - name: Squawk Check for New Migrations
      if: ${{ steps.generate-sql.outputs.changed == 'true' }}
      uses: sbdchd/squawk-action@v2
      with:
        pattern: migrations.sql